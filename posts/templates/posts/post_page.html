{% extends 'layout.html' %}
{% block title %}{{ post.title }}{% endblock %}
{% block content %}
<section>
    <article>
        {% if post.banner %}
            <img src="{{ post.banner.url }}" alt="{{ post.title }}" style="max-width: 100%; border-radius: 15px; margin-bottom: 20px;">
        {% endif %}
        
        <h1>{{ post.title }}</h1>
        
        <div class="post-meta" style="margin-bottom: 30px;">
            <span class="post-date">{{ post.date|date:"F d, Y" }}</span>
            <span class="post-author">
                By <a href="{% url 'register:profile' username=post.author.username %}" style="color: #667eea; text-decoration: none; font-weight: 600;">
                    {{ post.author.username }}
                </a>
            </span>
        </div>
        
        <div class="author-card" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px; display: flex; align-items: center; gap: 20px;">
            <div>
                {% if post.author.profile.profile_picture %}
                    <img src="{{ post.author.profile.profile_picture.url }}" alt="{{ post.author.username }}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">
                {% else %}
                    <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 24px; color: white;">
                        {{ post.author.username|first|upper }}
                    </div>
                {% endif %}
            </div>
            <div>
                <strong>{{ post.author.username }}</strong>
                {% if post.author.profile.bio %}
                    <p style="margin: 5px 0 0 0; color: #666;">{{ post.author.profile.bio|truncatewords:20 }}</p>
                {% endif %}
                <a href="{% url 'register:profile' username=post.author.username %}" style="font-size: 0.9em;">View Profile ‚Üí</a>
            </div>
        </div>
        
        <p style="white-space: pre-line;">{{ post.body }}</p>
        
        <div class="post-engagement">
            <div class="like-section">
                {% if user.is_authenticated %}
                    <form method="post" action="{% url 'posts:like' slug=post.slug %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn-like {% if user_has_liked %}liked{% endif %}">
                            {% if user_has_liked %}‚ù§Ô∏è{% else %}ü§ç{% endif %} {{ like_count }}
                        </button>
                    </form>
                {% else %}
                    <span class="like-display">‚ù§Ô∏è {{ like_count }}</span>
                {% endif %}
            </div>
            <div class="comment-count">
                üí¨ {{ comment_count }} comment{{ comment_count|pluralize }}
            </div>
        </div>
        
        {% if user.is_authenticated and post.author == user %}
            <div class="post-actions">
                <a href="{% url 'posts:edit' slug=post.slug %}" class="btn-edit">‚úèÔ∏è Edit Post</a>
                <form method="post" action="{% url 'posts:delete' slug=post.slug %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn-delete" onclick="return confirm('Are you sure you want to delete this post?');">üóëÔ∏è Delete Post</button>
                </form>
            </div>
        {% endif %}
    </article>
    
    <div class="comments-section">
        <h2>üí¨ Comments ({{ comment_count }})</h2>
        
        {% if user.is_authenticated %}
            <div class="comment-form-container">
                <h3>Leave a Comment</h3>
                <form method="post" class="comment-form">
                    {% csrf_token %}
                    {{ form.body }}
                    <button type="submit" class="btn-comment">Post Comment</button>
                </form>
            </div>
        {% else %}
            <div class="login-prompt">
                <p>Please <a href="{% url 'register:login' %}">login</a> to leave a comment.</p>
            </div>
        {% endif %}
        
        {% if comments %}
            <div class="comments-list">
                {% for comment in comments %}
                    <div class="comment" id="comment-{{ comment.id }}">
                        <div class="comment-header">
                            <div class="comment-author">
                                {% if comment.author.profile.profile_picture %}
                                    <img src="{{ comment.author.profile.profile_picture.url }}" alt="{{ comment.author.username }}" class="comment-avatar">
                                {% else %}
                                    <div class="comment-avatar-placeholder">
                                        {{ comment.author.username|first|upper }}
                                    </div>
                                {% endif %}
                                <div class="comment-meta">
                                    <a href="{% url 'register:profile' username=comment.author.username %}" class="comment-author-name">
                                        {{ comment.author.username }}
                                        {% if comment.author == post.author %}
                                            <span class="author-badge">Author</span>
                                        {% endif %}
                                    </a>
                                    <span class="comment-date">{{ comment.created_at|timesince }} ago</span>
                                    {% if comment.created_at != comment.updated_at %}
                                        <span class="edited-badge">(edited)</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="comment-body">
                            <p>{{ comment.body }}</p>
                        </div>
                        
                        {% if user.is_authenticated %}
                            {% if comment.author == user or post.author == user %}
                                <div class="comment-actions">
                                    {% if comment.author == user %}
                                        <a href="{% url 'posts:edit_comment' id=comment.id %}" class="btn-edit-comment">‚úèÔ∏è Edit</a>
                                    {% endif %}
                                    <form method="post" action="{% url 'posts:delete_comment' id=comment.id %}" style="display: inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn-delete-comment" onclick="return confirm('Delete this comment?');">üóëÔ∏è Delete</button>
                                    </form>
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="no-comments">
                <p>No comments yet. Be the first to comment!</p>
            </div>
        {% endif %}
    </div>
    
    <div style="text-align: center; margin-top: 40px;">
        <a href="{% url 'posts:posts' %}" style="display: inline-block;">‚Üê Back to All Posts</a>
    </div>
</section>
{% endblock %}
